import taichi as ti
from taichi.math import *


@ti.func
def sd_bunny(
    p_in: vec3, s: vec3
) -> float:  # from https://www.shadertoy.com/view/wtVyWK
    # sdf is undefined outside the unit sphere, uncomment to witness the abominations
    sd = 0.0
    p = p_in / s.x
    if length(p) > 1.0:
        sd = length(p) - 0.8
    else:
        # neural networks can be really compact... when they want to be
        f00 = sin(
            p.y * vec4(-3.02, 1.95, -3.42, -0.60)
            + p.z * vec4(3.08, 0.85, -2.25, -0.24)
            - p.x * vec4(-0.29, 1.16, -3.74, 2.89)
            + vec4(-0.71, 4.50, -3.24, -3.50)
        )
        f01 = sin(
            p.y * vec4(-0.40, -3.61, 3.23, -0.14)
            + p.z * vec4(-0.36, 3.64, -3.91, 2.66)
            - p.x * vec4(2.90, -0.54, -2.75, 2.71)
            + vec4(7.02, -5.41, -1.12, -7.41)
        )
        f02 = sin(
            p.y * vec4(-1.77, -1.28, -4.29, -3.20)
            + p.z * vec4(-3.49, -2.81, -0.64, 2.79)
            - p.x * vec4(3.15, 2.14, -3.85, 1.83)
            + vec4(-2.07, 4.49, 5.33, -2.17)
        )
        f03 = sin(
            p.y * vec4(-0.49, 0.68, 3.05, 0.42)
            + p.z * vec4(-2.87, 0.78, 3.78, -3.41)
            - p.x * vec4(-2.65, 0.33, 0.07, -0.64)
            + vec4(-3.24, -5.90, 1.14, -4.71)
        )
        f10 = (
            sin(
                f00
                @ mat4(
                    -0.34,
                    0.06,
                    -0.59,
                    -0.76,
                    0.10,
                    -0.19,
                    -0.12,
                    0.44,
                    0.64,
                    -0.02,
                    -0.26,
                    0.15,
                    -0.16,
                    0.21,
                    0.91,
                    0.15,
                )
                + f01
                @ mat4(
                    0.01,
                    0.54,
                    -0.77,
                    0.11,
                    0.06,
                    -0.14,
                    0.43,
                    0.51,
                    -0.18,
                    0.08,
                    0.39,
                    0.20,
                    0.33,
                    -0.49,
                    -0.10,
                    0.19,
                )
                + f02
                @ mat4(
                    0.27,
                    0.22,
                    0.43,
                    0.53,
                    0.18,
                    -0.17,
                    0.23,
                    -0.64,
                    -0.14,
                    0.02,
                    -0.10,
                    0.16,
                    -0.13,
                    -0.06,
                    -0.04,
                    -0.36,
                )
                + f03
                @ mat4(
                    -0.13,
                    0.29,
                    -0.29,
                    0.08,
                    1.13,
                    0.02,
                    -0.83,
                    0.32,
                    -0.32,
                    0.04,
                    -0.31,
                    -0.16,
                    0.14,
                    -0.03,
                    -0.20,
                    0.39,
                )
                + vec4(0.73, -4.28, -1.56, -1.80)
            )
            + f00
        )
        f11 = (
            sin(
                f00
                @ mat4(
                    -1.11,
                    0.55,
                    -0.12,
                    -1.00,
                    0.16,
                    0.15,
                    -0.30,
                    0.31,
                    -0.01,
                    0.01,
                    0.31,
                    -0.42,
                    -0.29,
                    0.38,
                    -0.04,
                    0.71,
                )
                + f01
                @ mat4(
                    0.96,
                    -0.02,
                    0.86,
                    0.52,
                    -0.14,
                    0.60,
                    0.44,
                    0.43,
                    0.02,
                    -0.15,
                    -0.49,
                    -0.05,
                    -0.06,
                    -0.25,
                    -0.03,
                    -0.22,
                )
                + f02
                @ mat4(
                    0.52,
                    0.44,
                    -0.05,
                    -0.11,
                    -0.56,
                    -0.10,
                    -0.61,
                    -0.40,
                    -0.04,
                    0.55,
                    0.32,
                    -0.07,
                    -0.02,
                    0.28,
                    0.26,
                    -0.49,
                )
                + f03
                @ mat4(
                    0.02,
                    -0.32,
                    0.06,
                    -0.17,
                    -0.59,
                    0.00,
                    -0.24,
                    0.60,
                    -0.06,
                    0.13,
                    -0.21,
                    -0.27,
                    -0.12,
                    -0.14,
                    0.58,
                    -0.55,
                )
                + vec4(-2.24, -3.48, -0.80, 1.41)
            )
            + f01
        )
        f12 = (
            sin(
                f00
                @ mat4(
                    0.44,
                    -0.06,
                    -0.79,
                    -0.46,
                    0.05,
                    -0.60,
                    0.30,
                    0.36,
                    0.35,
                    0.12,
                    0.02,
                    0.12,
                    0.40,
                    -0.26,
                    0.63,
                    -0.21,
                )
                + f01
                @ mat4(
                    -0.48,
                    0.43,
                    -0.73,
                    -0.40,
                    0.11,
                    -0.01,
                    0.71,
                    0.05,
                    -0.25,
                    0.25,
                    -0.28,
                    -0.20,
                    0.32,
                    -0.02,
                    -0.84,
                    0.16,
                )
                + f02
                @ mat4(
                    0.39,
                    -0.07,
                    0.90,
                    0.36,
                    -0.38,
                    -0.27,
                    -1.86,
                    -0.39,
                    0.48,
                    -0.20,
                    -0.05,
                    0.10,
                    -0.00,
                    -0.21,
                    0.29,
                    0.63,
                )
                + f03
                @ mat4(
                    0.46,
                    -0.32,
                    0.06,
                    0.09,
                    0.72,
                    -0.47,
                    0.81,
                    0.78,
                    0.90,
                    0.02,
                    -0.21,
                    0.08,
                    -0.16,
                    0.22,
                    0.32,
                    -0.13,
                )
                + vec4(3.38, 1.20, 0.84, 1.41)
            )
            + f02
        )
        f13 = (
            sin(
                f00
                @ mat4(
                    -0.41,
                    -0.24,
                    -0.71,
                    -0.25,
                    -0.24,
                    -0.75,
                    -0.09,
                    0.02,
                    -0.27,
                    -0.42,
                    0.02,
                    0.03,
                    -0.01,
                    0.51,
                    -0.12,
                    -1.24,
                )
                + f01
                @ mat4(
                    0.64,
                    0.31,
                    -1.36,
                    0.61,
                    -0.34,
                    0.11,
                    0.14,
                    0.79,
                    0.22,
                    -0.16,
                    -0.29,
                    -0.70,
                    0.02,
                    -0.37,
                    0.49,
                    0.39,
                )
                + f02
                @ mat4(
                    0.79,
                    0.47,
                    0.54,
                    -0.47,
                    -1.13,
                    -0.35,
                    -1.03,
                    -0.22,
                    -0.67,
                    -0.26,
                    0.10,
                    0.21,
                    -0.07,
                    -0.73,
                    -0.11,
                    0.72,
                )
                + f03
                @ mat4(
                    0.43,
                    -0.23,
                    0.13,
                    0.09,
                    1.38,
                    -0.63,
                    1.57,
                    -0.20,
                    0.39,
                    -0.14,
                    0.42,
                    0.13,
                    -0.57,
                    -0.08,
                    -0.21,
                    0.21,
                )
                + vec4(-0.34, -3.28, 0.43, -0.52)
            )
            + f03
        )
        f00 = (
            sin(
                f10
                @ mat4(
                    -0.72,
                    0.23,
                    -0.89,
                    0.52,
                    0.38,
                    0.19,
                    -0.16,
                    -0.88,
                    0.26,
                    -0.37,
                    0.09,
                    0.63,
                    0.29,
                    -0.72,
                    0.30,
                    -0.95,
                )
                + f11
                @ mat4(
                    -0.22,
                    -0.51,
                    -0.42,
                    -0.73,
                    -0.32,
                    0.00,
                    -1.03,
                    1.17,
                    -0.20,
                    -0.03,
                    -0.13,
                    -0.16,
                    -0.41,
                    0.09,
                    0.36,
                    -0.84,
                )
                + f12
                @ mat4(
                    -0.21,
                    0.01,
                    0.33,
                    0.47,
                    0.05,
                    0.20,
                    -0.44,
                    -1.04,
                    0.13,
                    0.12,
                    -0.13,
                    0.31,
                    0.01,
                    -0.34,
                    0.41,
                    -0.34,
                )
                + f13
                @ mat4(
                    -0.13,
                    -0.06,
                    -0.39,
                    -0.22,
                    0.48,
                    0.25,
                    0.24,
                    -0.97,
                    -0.34,
                    0.14,
                    0.42,
                    -0.00,
                    -0.44,
                    0.05,
                    0.09,
                    -0.95,
                )
                + vec4(0.48, 0.87, -0.87, -2.06)
            )
            / 1.4
            + f10
        )
        f01 = (
            sin(
                f10
                @ mat4(
                    -0.27,
                    0.29,
                    -0.21,
                    0.15,
                    0.34,
                    -0.23,
                    0.85,
                    -0.09,
                    -1.15,
                    -0.24,
                    -0.05,
                    -0.25,
                    -0.12,
                    -0.73,
                    -0.17,
                    -0.37,
                )
                + f11
                @ mat4(
                    -1.11,
                    0.35,
                    -0.93,
                    -0.06,
                    -0.79,
                    -0.03,
                    -0.46,
                    -0.37,
                    0.60,
                    -0.37,
                    -0.14,
                    0.45,
                    -0.03,
                    -0.21,
                    0.02,
                    0.59,
                )
                + f12
                @ mat4(
                    -0.92,
                    -0.17,
                    -0.58,
                    -0.18,
                    0.58,
                    0.60,
                    0.83,
                    -1.04,
                    -0.80,
                    -0.16,
                    0.23,
                    -0.11,
                    0.08,
                    0.16,
                    0.76,
                    0.61,
                )
                + f13
                @ mat4(
                    0.29,
                    0.45,
                    0.30,
                    0.39,
                    -0.91,
                    0.66,
                    -0.35,
                    -0.35,
                    0.21,
                    0.16,
                    -0.54,
                    -0.63,
                    1.10,
                    -0.38,
                    0.20,
                    0.15,
                )
                + vec4(-1.72, -0.14, 1.92, 2.08)
            )
            / 1.4
            + f11
        )
        f02 = (
            sin(
                f10
                @ mat4(
                    1.00,
                    0.66,
                    1.30,
                    -0.51,
                    0.88,
                    0.25,
                    -0.67,
                    0.03,
                    -0.68,
                    -0.08,
                    -0.12,
                    -0.14,
                    0.46,
                    1.15,
                    0.38,
                    -0.10,
                )
                + f11
                @ mat4(
                    0.51,
                    -0.57,
                    0.41,
                    -0.09,
                    0.68,
                    -0.50,
                    -0.04,
                    -1.01,
                    0.20,
                    0.44,
                    -0.60,
                    0.46,
                    -0.09,
                    -0.37,
                    -1.30,
                    0.04,
                )
                + f12
                @ mat4(
                    0.14,
                    0.29,
                    -0.45,
                    -0.06,
                    -0.65,
                    0.33,
                    -0.37,
                    -0.95,
                    0.71,
                    -0.07,
                    1.00,
                    -0.60,
                    -1.68,
                    -0.20,
                    -0.00,
                    -0.70,
                )
                + f13
                @ mat4(
                    -0.31,
                    0.69,
                    0.56,
                    0.13,
                    0.95,
                    0.36,
                    0.56,
                    0.59,
                    -0.63,
                    0.52,
                    -0.30,
                    0.17,
                    1.23,
                    0.72,
                    0.95,
                    0.75,
                )
                + vec4(-0.90, -3.26, -0.44, -3.11)
            )
            / 1.4
            + f12
        )
        f03 = (
            sin(
                f10
                @ mat4(
                    0.51,
                    -0.98,
                    -0.28,
                    0.16,
                    -0.22,
                    -0.17,
                    -1.03,
                    0.22,
                    0.70,
                    -0.15,
                    0.12,
                    0.43,
                    0.78,
                    0.67,
                    -0.85,
                    -0.25,
                )
                + f11
                @ mat4(
                    0.81,
                    0.60,
                    -0.89,
                    0.61,
                    -1.03,
                    -0.33,
                    0.60,
                    -0.11,
                    -0.06,
                    0.01,
                    -0.02,
                    -0.44,
                    0.73,
                    0.69,
                    1.02,
                    0.62,
                )
                + f12
                @ mat4(
                    -0.10,
                    0.52,
                    0.80,
                    -0.65,
                    0.40,
                    -0.75,
                    0.47,
                    1.56,
                    0.03,
                    0.05,
                    0.08,
                    0.31,
                    -0.03,
                    0.22,
                    -1.63,
                    0.07,
                )
                + f13
                @ mat4(
                    -0.18,
                    -0.07,
                    -1.22,
                    0.48,
                    -0.01,
                    0.56,
                    0.07,
                    0.15,
                    0.24,
                    0.25,
                    -0.09,
                    -0.54,
                    0.23,
                    -0.08,
                    0.20,
                    0.36,
                )
                + vec4(-1.11, -4.28, 1.02, -0.23)
            )
            / 1.4
            + f13
        )
        sd = (
            dot(f00, vec4(0.09, 0.12, -0.07, -0.03))
            + dot(f01, vec4(-0.04, 0.07, -0.08, 0.05))
            + dot(f02, vec4(-0.01, 0.06, -0.02, 0.07))
            + dot(f03, vec4(-0.05, 0.07, 0.03, 0.04))
            - 0.16
        )

    return sd * s.x
